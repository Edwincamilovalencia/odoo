<?xml version="1.0" encoding="UTF-8"?>
<odoo>


    <record id="view_task_form_custom" model="ir.ui.view">
        <field name="name">project.task.form.inherit</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="project.view_task_form2" />
        <field name="arch" type="xml">
            <xpath expr="//header" position="inside">

                <field name="state"
                    widget="statusbar"
                    statusbar_visible="pending,in_progress,done,cancelled"
                    statusbar_colors="{
                               'pending': 'orange',
                               'in_progress': 'blue',
                               'done': 'green',
                               'cancelled': 'red'
                           }"
                    string="Estado"
                    class="me-4" />

            </xpath>

            <xpath expr="//header/field[@name='personal_stage_type_id']" position="replace">
                    <button name="action_start_activity"
                        type="object"
                        string="Iniciar"
                        class="btn btn-primary"
                        icon="fa-play"
                        modifiers="{'invisible': [('state', '!=', 'pending')]}" />

                    <button name="action_finish_activity"
                        type="object"
                        string="Completar"
                        class="btn btn-success"
                        icon="fa-check-circle"
                        modifiers="{'invisible': [('state', '!=', 'in_progress')]}" />

                    <button name="action_cancel_activity"
                        type="object"
                        string="Cancelar"
                        class="btn btn-danger"
                        icon="fa-times-circle"
                        modifiers="{'invisible': [('state', 'not in', ['pending', 'in_progress'])]}" />
            </xpath>


            <xpath expr="//field[@name='task_properties']" position="before">
                <group string="Detalles">
                    <group>
                        <field name="specific_objective_id" domain="[('project_id', '=', project_id)]"
                        modifiers="{'readonly': [('state', '!=', 'pending')]}"/>
                        <field name="dependent_task_ids" widget="many2many_tags" domain="[('project_id', '=', project_id)]" options="{'no_create': True}"
                        modifiers="{'readonly': [('state', '!=', 'pending')]}"
                        />

                    </group>

                </group>
            </xpath>

            <!-- Pestaña de materiales -->
            <xpath expr="//notebook" position="inside">
                <page string="Materiales">
                    <field name="material_budget_ids">
                        <tree editable="bottom">
                            <!-- bodega para filtrar productos -->
                            <field name="warehouse_id" required="1" />
                            <field name="name"
                                domain="[('qty_available', '>', 0)]"
                                modifiers="{'readonly': [('warehouse_id', '=', False)]}" />

                            <field name="qty" modifiers="{'readonly': [('warehouse_id', '=', False)]}" />
                            <field name="qty_available" readonly="1" />
                            <field name="estimed_coste" readonly="1" />

                            <!-- Ocultamos los campos que solo usamos como lógica para mostrar
                            botones -->
                            <field name="show_request_button" invisible="1" />
                            <field name="show_entry_button" invisible="1" />

                            <!-- Botón: Solicitar Material -->
                            <button name="action_solicitar_material"
                                string="Solicitar"
                                type="object"
                                class="btn-primary"
                                icon="fa-paper-plane"
                                modifiers="{'invisible': [('show_request_button', '=', False)]}"
                                context="{'default_warehouse_id': warehouse_id}" />


                        </tree>
                    </field>
                </page>
                <page string="Evidencias">
                    <field name="evidence_ids">
                        <tree editable="bottom">
                            <field name="name" string="Nombre de la Evidencia" />
                            <field name="file" filename="filename" widget="binary" string="Archivo" />
                        </tree>
                    </field>
                </page>


            </xpath>
            <xpath expr="//field[@name='tag_ids']" position="after">
                <field name="progress_percentage" widget="progressbar" readonly="1" />
            </xpath>


        </field>
    </record>
    <!-- Hacer que Mis Tareas se abran primero en vista de Lista y luego en Kanban -->
    <record id="project.action_view_my_task" model="ir.actions.act_window">
        <field name="view_mode">tree,kanban,form,calendar,pivot,graph,activity</field>
        <field name="views" eval="[(ref('project.open_view_my_tasks_list_view'), 'tree'), (ref('project.view_task_kanban_inherit_my_task'), 'kanban')]"/>
        <field name="view_id" ref="project.open_view_my_tasks_list_view"/>
    </record>

    <!--vista de lista tenga una secuencia menor que la vista kanban para Mis Tareas -->
    <record id="project.open_view_my_task_list_tree" model="ir.actions.act_window.view">
        <field name="sequence" eval="0"/>
        <field name="view_mode">tree</field>
        <field name="view_id" ref="project.open_view_my_tasks_list_view"/>
        <field name="act_window_id" ref="project.action_view_my_task"/>
    </record>

    <record id="project.open_view_my_task_list_kanban" model="ir.actions.act_window.view">
        <field name="sequence" eval="10"/>
        <field name="view_mode">kanban</field>
        <field name="view_id" ref="project.view_task_kanban_inherit_my_task"/>
        <field name="act_window_id" ref="project.action_view_my_task"/>
    </record>
</odoo>